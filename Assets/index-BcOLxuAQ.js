var E=Object.defineProperty;var I=(h,t,e)=>t in h?E(h,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):h[t]=e;var o=(h,t,e)=>I(h,typeof t!="symbol"?t+"":t,e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))a(i);new MutationObserver(i=>{for(const s of i)if(s.type==="childList")for(const l of s.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&a(l)}).observe(document,{childList:!0,subtree:!0});function e(i){const s={};return i.integrity&&(s.integrity=i.integrity),i.referrerPolicy&&(s.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?s.credentials="include":i.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function a(i){if(i.ep)return;i.ep=!0;const s=e(i);fetch(i.href,s)}})();var n=(h=>(h[h.A=0]="A",h[h.B=1]="B",h[h.C=2]="C",h[h.D=3]="D",h))(n||{});class L{constructor(){o(this,"playerScore",0);o(this,"cpuScore",0);o(this,"failCount",0);o(this,"winTarget");o(this,"highScore",0);o(this,"gameStarted",!1);o(this,"difficulty","normal");o(this,"playerChoiceHistory",[]);o(this,"bgmMuted",!1);o(this,"gamePoints",0);o(this,"playerLives",10);o(this,"newPoints",0);o(this,"isRoundActive",!1);o(this,"objDTriggerCount",0);o(this,"objDActive",!1);o(this,"lastCheckedWins",0);o(this,"sounds",{select:new Audio("/PokeFanBattle/Assets/Audio/select.wav"),win:new Audio("/PokeFanBattle/Assets/Audio/win.wav"),lose:new Audio("/PokeFanBattle/Assets/Audio/lose.wav"),tie:new Audio("/PokeFanBattle/Assets/Audio/tie.wav"),"end-win":new Audio("/PokeFanBattle/Assets/Audio/end-win.wav"),"end-lose":new Audio("/PokeFanBattle/Assets/Audio/end-lose.wav"),opening:new Audio("/PokeFanBattle/Assets/Audio/opening.wav"),"sound-a":new Audio("/PokeFanBattle/Assets/Audio/sound-a.ogg"),"sound-b":new Audio("/PokeFanBattle/Assets/Audio/sound-b.ogg"),"sound-c":new Audio("/PokeFanBattle/Assets/Audio/sound-c.ogg"),objD1:new Audio("/PokeFanBattle/Assets/Audio/sound_objD_1.wav"),objD2:new Audio("/PokeFanBattle/Assets/Audio/sound_objD_2.wav"),"life-up":new Audio("/PokeFanBattle/Assets/Audio/life-up.wav")});o(this,"bgm",{opening:new Audio("/PokeFanBattle/Assets/Audio/opening-bgm.ogg"),battle:new Audio("/PokeFanBattle/Assets/Audio/battle-bgm.ogg"),end:new Audio("/PokeFanBattle/Assets/Audio/end-bgm.ogg")});o(this,"audioContext");o(this,"bgmSource",null);o(this,"gainNode");o(this,"currentBgmKey",null);o(this,"objectNames",{[n.A]:"A",[n.B]:"B",[n.C]:"C",[n.D]:"D"});o(this,"playerImages",{[n.A]:"/PokeFanBattle/Assets/Img/choiced_a_400.png",[n.B]:"/PokeFanBattle/Assets/Img/choiced_b_400.png",[n.C]:"/PokeFanBattle/Assets/Img/choiced_c_400.png",[n.D]:"/PokeFanBattle/Assets/Img/img_objD_400.png"});o(this,"cpuImages",{[n.A]:"/PokeFanBattle/Assets/Img/choiced_a_cpu400.png",[n.B]:"/PokeFanBattle/Assets/Img/choiced_b_cpu400.png",[n.C]:"/PokeFanBattle/Assets/Img/choiced_c_cpu400.png",[n.D]:""});o(this,"objectButtonImages",{[n.A]:"/PokeFanBattle/Assets/Img/icon_a_60.png",[n.B]:"/PokeFanBattle/Assets/Img/icon_b_60.png",[n.C]:"/PokeFanBattle/Assets/Img/icon_c_60.png",[n.D]:""});o(this,"playerCanvas");o(this,"cpuCanvas");o(this,"playerCtx");o(this,"cpuCtx");o(this,"animationFrameId",null);this.loadHighScore(),this.loadGamePoints(),Object.values(this.sounds).forEach(t=>t.volume=.5),Object.values(this.bgm).forEach(t=>{t.volume=.3,t.loop=!0}),this.audioContext=new AudioContext,this.gainNode=this.audioContext.createGain(),this.gainNode.connect(this.audioContext.destination),this.gainNode.gain.value=.3,this.playerCanvas=document.getElementById("playerCanvas"),this.cpuCanvas=document.getElementById("cpuCanvas"),console.log("Player Canvas:",this.playerCanvas),console.log("CPU Canvas:",this.cpuCanvas),this.playerCtx=this.playerCanvas.getContext("2d"),this.cpuCtx=this.cpuCanvas.getContext("2d"),console.log("Player Context:",this.playerCtx),console.log("CPU Context:",this.cpuCtx),this.playerCanvas.width=300,this.playerCanvas.height=300,this.cpuCanvas.width=300,this.cpuCanvas.height=300}loadHighScore(){this.highScore=parseInt(localStorage.getItem("highScore")||"0")}saveHighScore(){localStorage.setItem("highScore",this.highScore.toString())}loadGamePoints(){this.gamePoints=parseInt(localStorage.getItem("gamePoints")||"0")}saveGamePoints(){localStorage.setItem("gamePoints",this.gamePoints.toString())}}const S=new L;class A{constructor(t){o(this,"state");this.state=t}showExitModal(){const t=document.querySelector("#exitModal");t&&t.classList.remove("hidden")}hideExitModal(){const t=document.querySelector("#exitModal");t&&t.classList.add("hidden")}exitGame(){this.hideExitModal(),this.toggleScreens("startScreen")}async addLifeWithAnimation(){var a;if(this.state.winTarget!==0)return;this.state.playerLives++,this.updatePlayerLives();const e=document.getElementById("playerlife").lastElementChild;if(e){e.classList.add("life-gain");const i=document.createElement("div");i.classList.add("life-wrapper"),(a=e.parentNode)==null||a.insertBefore(i,e),i.appendChild(e);const s=document.createElement("div");s.classList.add("plus-one"),s.textContent="+1",i.appendChild(s),this.state.sounds["life-up"].currentTime=0,this.state.sounds["life-up"].play(),await new Promise(l=>setTimeout(l,1500)),e.classList.remove("life-gain"),i.replaceWith(e)}}async showObjDPopup(){const t=document.getElementById("gameScreen2");if(!t){console.error("gameScreen2 not found!");return}const e=document.createElement("div");e.id="objD-popup",e.style.backgroundImage="url('/PokeFanBattle/Assets/Img/img_objD_big.png')",t.appendChild(e),console.log("Popup appended to gameScreen2");try{this.state.sounds.objD1.currentTime=0,await this.state.sounds.objD1.play(),console.log("Object D sound played successfully")}catch(a){console.error("Failed to play Object D sound:",a)}await new Promise(a=>setTimeout(a,1100)),e.classList.add("shrink"),console.log("Shrink animation started"),await new Promise(a=>setTimeout(a,500)),e.remove(),console.log("Object D popup removed")}showChoices(t,e){const a=document.getElementById("playerVersus"),i=document.getElementById("cpuVersus");console.log(`Showing choices: Player=${this.state.objectNames[t]}, CPU=${this.state.objectNames[e]}`),console.log(`Player image URL: ${this.state.playerImages[t]}`),console.log(`CPU image URL: ${this.state.cpuImages[e]}`),a.style.backgroundImage=`url('${this.state.playerImages[t]}')`,i.style.backgroundImage=`url('${this.state.cpuImages[e]}')`,a.className="choice-display choice-appear",i.className="choice-display choice-appear";const s=["objA","objB","objC"],l=["objA-cpu","objB-cpu","objC-cpu"];s.forEach((d,r)=>{const c=document.getElementById(d);c.style.opacity=r===(t===n.D?-1:t)?"1":"0.5"}),l.forEach((d,r)=>{const c=document.getElementById(d);c.style.opacity=2-r===e?"1":"0.5"})}startObjDElectricEffect(){this.state.animationFrameId&&cancelAnimationFrame(this.state.animationFrameId);const t=[],e=95,a=60,i=()=>{if(this.state.playerCtx.clearRect(0,0,300,300),this.state.cpuCtx.clearRect(0,0,300,300),t.length<e)for(let s=0;s<5;s++){const l=Math.random()*Math.PI*2,d=(Math.random()*3+1)*4;t.push({x:150,y:150,vx:Math.cos(l)*d,vy:Math.sin(l)*d,life:a})}t.forEach((s,l)=>{s.x+=s.vx,s.y+=s.vy,s.life--,(s.x<0||s.x>300)&&(s.vx*=-1),(s.y<0||s.y>300)&&(s.vy*=-1);const d=s.x-150,r=s.y-150;if(Math.sqrt(d*d+r*r)>200){const u=Math.atan2(r,d);s.x=150+Math.cos(u)*200,s.y=150+Math.sin(u)*200,s.vx*=-.5,s.vy*=-.5}if(this.state.playerCtx.beginPath(),this.state.playerCtx.arc(s.x,s.y,2,0,Math.PI*2),this.state.playerCtx.fillStyle=`rgba(255, 255, 0, ${s.life/a})`,this.state.playerCtx.fill(),Math.random()<.1){const u=t[Math.floor(Math.random()*t.length)];this.state.playerCtx.beginPath(),this.state.playerCtx.moveTo(s.x,s.y),this.state.playerCtx.lineTo(u.x,u.y),this.state.playerCtx.strokeStyle=`rgba(255, 215, 0, ${s.life/a*.7})`,this.state.playerCtx.lineWidth=1,this.state.playerCtx.stroke()}s.life<=0&&t.splice(l,1)}),t.length>0?this.state.animationFrameId=requestAnimationFrame(i):(this.state.playerCtx.clearRect(0,0,300,300),this.state.animationFrameId=null)};this.state.animationFrameId=requestAnimationFrame(i)}startElectricEffect(t,e){console.log("Starting electric effect for:",t,e),this.state.animationFrameId&&cancelAnimationFrame(this.state.animationFrameId);const a=[],i=150,s=c=>{switch(c){case n.A:return{r:255,g:0,b:0};case n.B:return{r:0,g:255,b:0};case n.C:return{r:135,g:206,b:235};default:return{r:0,g:255,b:255}}},l=s(t),d=s(e),r=()=>{this.state.playerCtx.clearRect(0,0,300,300),this.state.cpuCtx.clearRect(0,0,300,300),a.length<3&&Math.random()<.1&&a.push({radius:0,opacity:1}),a.forEach((c,u)=>{c.radius+=2,c.opacity=1-c.radius/i,this.drawSegmentedCircle(this.state.playerCtx,150,150,c.radius,c.opacity,l),this.drawSegmentedCircle(this.state.cpuCtx,150,150,c.radius,c.opacity,d),this.drawElectricSparks(this.state.playerCtx,150,150,c.radius,c.opacity,l),this.drawElectricSparks(this.state.cpuCtx,150,150,c.radius,c.opacity,d),c.radius>=i&&a.splice(u,1)}),a.length>0?this.state.animationFrameId=requestAnimationFrame(r):(this.state.playerCtx.clearRect(0,0,300,300),this.state.cpuCtx.clearRect(0,0,300,300),this.state.animationFrameId=null)};a.push({radius:0,opacity:1}),this.state.animationFrameId=requestAnimationFrame(r)}drawSegmentedCircle(t,e,a,i,s,l){const r=Math.PI*2/12;t.strokeStyle=`rgba(${l.r}, ${l.g}, ${l.b}, ${s})`,t.lineWidth=2;for(let c=0;c<12;c++){const u=c*r+(Math.random()-.5)*.2,y=u+r*(.7+Math.random()*.3);t.beginPath(),t.arc(e,a,i,u,y),t.stroke()}}drawElectricSparks(t,e,a,i,s,l){for(let r=0;r<8;r++){const c=Math.random()*Math.PI*2,u=i+Math.random()*20,y=(Math.random()-.5)*10;t.beginPath(),t.moveTo(e+Math.cos(c)*i,a+Math.sin(c)*i),t.lineTo(e+Math.cos(c)*u+y,a+Math.sin(c)*u+y),t.strokeStyle=`rgba(${l.r}, ${l.g}, ${l.b}, ${s*.7})`,t.lineWidth=1.5,t.stroke()}}animateVersus(t){const e=document.getElementById("playerVersus"),a=document.getElementById("cpuVersus");e.classList.remove("choice-appear","strong","weak"),a.classList.remove("choice-appear","strong","weak"),t==="player"?(e.classList.add("strong"),a.classList.add("weak")):t==="cpu"&&(e.classList.add("weak"),a.classList.add("strong"))}updateScore(){document.getElementById("playerScore").textContent=this.state.playerScore.toString(),document.getElementById("cpuScore").textContent=this.state.cpuScore.toString(),this.state.winTarget===0&&this.updatePlayerLives()}updateHighScoreDisplay(){document.getElementById("highScore").textContent=this.state.highScore.toString()}updateGamePoints(){document.getElementById("gamePoints").textContent=this.state.gamePoints.toString()}initializeLives(){const t=document.getElementById("playerlife"),e=document.getElementById("cpulife");if(t.innerHTML="",e.innerHTML="",this.state.winTarget===0){for(let a=0;a<this.state.playerLives;a++){const i=document.createElement("div");i.classList.add("ball-small"),t.appendChild(i)}for(let a=0;a<9;a++){const i=document.createElement("div");i.classList.add("ball-small","blink"),e.appendChild(i)}e.classList.remove("hidden")}else e.classList.add("hidden")}updatePlayerLives(){const t=document.getElementById("playerlife");if(t.innerHTML="",this.state.winTarget===0)for(let e=0;e<this.state.playerLives;e++){const a=document.createElement("div");a.classList.add("ball-small"),t.appendChild(a)}}toggleScreens(t){this.state.animationFrameId&&(cancelAnimationFrame(this.state.animationFrameId),this.state.animationFrameId=null,this.state.playerCtx.clearRect(0,0,300,300),this.state.cpuCtx.clearRect(0,0,300,300));const a=["startScreen","gameScreen","endScreen"].find(i=>!document.getElementById(i).classList.contains("hidden"));if(a&&a!==t){const i=document.getElementById(a);i.classList.add("fade-out"),setTimeout(()=>{i.classList.add("hidden"),i.classList.remove("fade-out");const s=document.getElementById(t);s.classList.remove("hidden"),s.classList.add("fade-in"),t==="gameScreen"&&this.hideExitModal(),setTimeout(()=>s.classList.remove("fade-in"),300)},500)}else{const i=document.getElementById(t);i.classList.remove("hidden"),i.classList.add("fade-in"),t==="gameScreen"&&this.hideExitModal(),setTimeout(()=>i.classList.remove("fade-in"),300)}}async playBattleAnimation(t){const e=document.createElement("div");e.classList.add("transition-overlay"),document.body.appendChild(e);const a=document.createElement("div");a.classList.add("battle-region"),e.appendChild(a);const i=document.createElement("span");i.classList.add("battle-text"),i.textContent="BATTLE",a.appendChild(i),await new Promise(s=>setTimeout(s,1e3)),i.classList.add("burst"),i.textContent="START",await new Promise(s=>setTimeout(s,300)),a.classList.add("fade-out"),await new Promise(s=>setTimeout(s,500)),e.remove(),t.classList.remove("fade-in")}}const b=new A(S);class x{constructor(t){o(this,"state");this.state=t}getCpuChoice(){return[n.A,n.B,n.C][Math.floor(Math.random()*3)]}determineWinner(t,e){return t===n.D?"player":t===e?"tie":t===n.A&&e===n.B||t===n.B&&e===n.C||t===n.C&&e===n.A?"player":e===n.A&&t===n.B||e===n.B&&t===n.C||e===n.C&&t===n.A?"cpu":"tie"}checkObjDTrigger(){if(this.state.winTarget!==0)return;const t=this.state.playerScore;console.log(`Checking Object D: wins=${t}, lastCheckedWins=${this.state.lastCheckedWins}, objDTriggerCount=${this.state.objDTriggerCount}`);let e=0;t>=50?e=5:t>=35?e=Math.floor(Math.random()*2)+2:t>=15?e=Math.floor(Math.random()*2)+1:t>=5&&(e=1);const a=Math.floor(t/5)*5,i=Math.floor(this.state.lastCheckedWins/5)*5;t>0&&a>i&&this.state.objDTriggerCount<e?(this.state.objDActive=!0,this.state.objDTriggerCount++,console.log(`Object D marked for next round! Milestone: ${a}, Target Count: ${e}`)):console.log(`Object D not triggered. Conditions: wins=${t}, milestone=${a}, lastMilestone=${i}, triggerCount=${this.state.objDTriggerCount}, targetCount=${e}`),this.state.lastCheckedWins=t}checkHighScore(){this.state.winTarget===0&&this.state.playerScore>this.state.highScore&&(this.state.highScore=this.state.playerScore,this.state.saveHighScore(),alert("You set a new record!"))}checkGameEnd(){this.state.winTarget===0?this.state.playerLives<=0:this.state.playerScore>=this.state.winTarget||this.state.cpuScore>=this.state.winTarget}calculateGamePoints(t){let e=0;if(this.state.winTarget===0){const a=Math.floor(this.state.playerScore/10)*5;e=20+this.state.playerScore+a}else if(t)switch(this.state.winTarget){case 3:e=5;break;case 5:e=10;break;case 7:e=15;break;case 10:e=20;break}this.state.newPoints=this.state.difficulty==="hard"?e*2:e,this.state.gamePoints+=this.state.newPoints,this.state.saveGamePoints()}}const P=new x(S);class T{constructor(t,e,a){o(this,"state");o(this,"logic");o(this,"ui");this.state=t,this.logic=e,this.ui=a,this.setupEventListeners()}setupEvents(){}playOpening(){console.log("Playing opening sound and BGM"),this.state.sounds.opening.currentTime=0,this.state.sounds.opening.play(),this.playBgm("opening")}async playBgm(t){this.state.bgmMuted||(this.state.bgmSource?this.fadeOutBgm(()=>this.startNewBgm(t)):this.startNewBgm(t))}async startNewBgm(t){this.state.bgmSource&&(this.state.bgmSource.stop(),this.state.bgmSource.disconnect());const a=await(await fetch(this.state.bgm[t].src)).arrayBuffer(),i=await this.state.audioContext.decodeAudioData(a);this.state.bgmSource=this.state.audioContext.createBufferSource(),this.state.bgmSource.buffer=i,this.state.bgmSource.loop=!0,this.state.bgmSource.connect(this.state.gainNode),this.state.currentBgmKey=t,this.state.bgmSource.start(),this.fadeInBgm()}fadeInBgm(){this.state.gainNode.gain.setValueAtTime(0,this.state.audioContext.currentTime),this.state.gainNode.gain.linearRampToValueAtTime(.3,this.state.audioContext.currentTime+1)}fadeOutBgm(t){this.state.gainNode.gain.linearRampToValueAtTime(0,this.state.audioContext.currentTime+1),setTimeout(()=>{this.state.bgmSource&&(this.state.bgmSource.stop(),this.state.bgmSource.disconnect(),this.state.bgmSource=null),t()},1*1e3)}stopBgm(){this.state.bgmSource&&this.fadeOutBgm(()=>{this.state.bgmSource=null,this.state.currentBgmKey=null})}playSelectSound(){console.log("Playing select sound"),this.state.sounds.select.currentTime=0,this.state.sounds.select.play()}setupEventListeners(){console.log("Setting up event listeners");const t=document.getElementById("goal-mode"),e=document.getElementById("winInfinity"),a=document.getElementById("goal-options"),i=document.querySelector(".difficulty-toggle"),s=document.getElementById("start"),l=document.getElementById("difficulty-normal"),d=document.getElementById("difficulty-hard"),r=document.querySelector(".exit-button"),c=document.querySelector("#cancelExit"),u=document.querySelector("#confirmExit");r&&r.addEventListener("click",()=>{this.playSelectSound(),this.ui.showExitModal()}),c&&c.addEventListener("click",()=>{this.playSelectSound(),this.ui.hideExitModal()}),u&&u.addEventListener("click",()=>{this.playSelectSound(),this.ui.exitGame(),this.resetGame()}),document.addEventListener("click",m=>{const f=m.clientX,g=m.clientY,p=document.createElement("div");p.classList.add("ripple"),p.style.left=`${f}px`,p.style.top=`${g}px`,document.body.appendChild(p),p.addEventListener("animationend",()=>{p.remove()})}),t.addEventListener("click",()=>{this.playSelectSound(),this.playOpening(),e.classList.add("hidden"),a.classList.remove("hidden"),a.classList.add("visible"),console.log("Goal mode selected, showing options")}),e.addEventListener("click",()=>{this.playSelectSound(),this.setWinTarget(0),t.classList.add("hidden"),e.classList.add("hidden"),i.classList.remove("hidden"),document.getElementById("startScreen").querySelector("h2").textContent="You have chosen: INFINITY",console.log("Infinity mode selected, showing difficulty options")});const y=document.querySelectorAll(".goal-option");y.forEach(m=>{m.addEventListener("click",()=>{this.playSelectSound();const f=parseInt(m.getAttribute("data-wins"));this.setWinTarget(f),y.forEach(g=>g.classList.remove("selected")),m.classList.add("selected"),t.classList.add("hidden"),a.classList.remove("visible"),a.classList.add("hidden"),s.classList.remove("hidden"),document.getElementById("startScreen").querySelector("h2").textContent=`You have chosen: ${f}x WIN`,console.log(`Goal option selected: ${f} wins, showing start button`)})}),l.addEventListener("click",()=>{this.playSelectSound(),this.state.difficulty="normal",l.classList.add("selected"),d.classList.remove("selected"),i.classList.add("hidden"),s.classList.remove("hidden"),console.log("Difficulty set to Normal, showing start button")}),d.addEventListener("click",()=>{this.playSelectSound(),this.state.difficulty="hard",d.classList.add("selected"),l.classList.remove("selected"),i.classList.add("hidden"),s.classList.remove("hidden"),console.log("Difficulty set to Hard, showing start button")}),s.addEventListener("click",()=>{if(this.state.winTarget===void 0){alert("Please choose a game mode first!");return}this.playSelectSound(),this.startGame()}),[document.getElementById("startSoundControl"),document.getElementById("gameSoundControl"),document.getElementById("endSoundControl")].forEach(m=>{m&&m.addEventListener("click",()=>this.toggleBgm())}),document.getElementById("objA").addEventListener("click",()=>this.playRound(n.A)),document.getElementById("objB").addEventListener("click",()=>this.playRound(n.B)),document.getElementById("objC").addEventListener("click",()=>this.playRound(n.C)),document.getElementById("restart").addEventListener("click",()=>this.resetGame())}setWinTarget(t){this.state.gameStarted||(this.state.winTarget=t,console.log(`Win target set to: ${t}`),document.getElementById("startScreen").querySelector("h2").textContent=`You have choosen a Goal: ${t===0?"INFINITY":`${t}x WIN`}`)}startGame(){if(this.state.winTarget===void 0){console.log("Win target not set"),alert("Please choose a victory goal first！");return}console.log("Starting game"),this.state.playerScore=0,this.state.cpuScore=0,this.state.failCount=0,this.state.gameStarted=!0,this.state.isRoundActive=!1,this.state.playerChoiceHistory=[],this.state.playerLives=this.state.winTarget===0&&this.state.difficulty==="normal"?15:10,this.state.newPoints=0,this.state.objDTriggerCount=0,this.state.objDActive=!1,this.state.lastCheckedWins=0,this.ui.toggleScreens("gameScreen"),this.ui.updateScore(),this.ui.updateHighScoreDisplay(),this.ui.updateGamePoints(),this.ui.initializeLives(),document.getElementById("objA").style.backgroundImage=`url('${this.state.objectButtonImages[n.A]}')`,document.getElementById("objB").style.backgroundImage=`url('${this.state.objectButtonImages[n.B]}')`,document.getElementById("objC").style.backgroundImage=`url('${this.state.objectButtonImages[n.C]}')`,this.playBgm("battle")}async playRound(t){if(!this.state.gameStarted||this.state.isRoundActive)return;this.state.isRoundActive=!0,this.playSelectSound();const e=document.getElementById("playerVersus"),a=document.getElementById("cpuVersus");e.style.backgroundImage="none",a.style.backgroundImage="none",e.className="choice-display",a.className="choice-display",this.state.animationFrameId&&(cancelAnimationFrame(this.state.animationFrameId),this.state.animationFrameId=null),this.state.playerCtx.clearRect(0,0,this.state.playerCanvas.width,this.state.playerCanvas.height),this.state.cpuCtx.clearRect(0,0,this.state.cpuCanvas.width,this.state.cpuCanvas.height);const i=document.getElementById("gameScreen2"),s=document.createElement("div");s.classList.add("flying-ball"),i.appendChild(s);const l=document.getElementById("playerCanvas"),d=i.getBoundingClientRect(),r=l.getBoundingClientRect(),c=r.left-d.left+r.width/2,u=r.top-d.top+r.height/2,y=10,B=d.height-10,m=c-y,f=-(B-u);s.style.setProperty("--fly-end-transform",`translate(${m-40}px, ${f+10}px) scale(0.33)`),s.style.setProperty("--vanish-mid-transform",`translate(${m-40}px, ${f+15}px) scale(1)`),s.style.setProperty("--vanish-end-transform",`translate(${m-40}px, ${f+20}px) scale(2)`),s.style.animation="flyArc 0.8s cubic-bezier(0.4, 0, 0.2, 1) forwards",setTimeout(()=>{s.style.animation="vanishEffect 0.4s ease-in-out forwards",setTimeout(()=>s.remove(),400)},800);let g=t;this.state.objDActive&&(console.log("Object D activated, showing popup"),await this.ui.showObjDPopup(),g=n.D);const p=this.logic.getCpuChoice();await new Promise(v=>setTimeout(v,1200)),this.ui.showChoices(g,p);const C=this.logic.determineWinner(g,p);if(C==="player"){this.state.playerScore++,console.log(`Player wins! Score: ${this.state.playerScore}`),this.logic.checkObjDTrigger();const v=this.state.difficulty==="normal"?5:10;this.state.winTarget===0&&this.state.playerScore%v===0&&await this.ui.addLifeWithAnimation()}else C==="cpu"?(this.state.cpuScore++,this.state.failCount++,this.state.winTarget===0&&this.state.playerLives--,console.log(`CPU wins! Lives: ${this.state.playerLives}`)):(this.state.failCount++,console.log("Tie!"));this.state.playerChoiceHistory.push(g),this.state.playerChoiceHistory.length>5&&this.state.playerChoiceHistory.shift();const w=g===n.D?"objD1":`sound-${this.state.objectNames[g].toLowerCase()}`;await this.playEnhancedSound(w),setTimeout(()=>{this.ui.animateVersus(C),C==="player"?(this.state.sounds.win.currentTime=0,this.state.sounds.win.play()):C==="cpu"?(this.state.sounds.lose.currentTime=0,this.state.sounds.lose.play()):(this.state.sounds.tie.currentTime=0,this.state.sounds.tie.play()),g===n.D?(this.state.sounds.objD2.currentTime=0,this.state.sounds.objD2.play(),this.state.objDActive=!1,console.log("Object D effects applied"),this.ui.startObjDElectricEffect()):this.ui.startElectricEffect(g,p),setTimeout(()=>{this.ui.updateScore(),this.checkGameEnd(),this.state.isRoundActive=!1},600)},800)}endGame(t){this.state.gameStarted=!1,this.state.isRoundActive=!1,this.logic.calculateGamePoints(t),this.ui.toggleScreens("endScreen"),document.getElementById("endMessage").textContent=t?"You Win! Congratulation!":"You lost! Try again!",document.getElementById("endMessage").className=t?"won":"lost",document.getElementById("finalPlayerScore").textContent=this.state.playerScore.toString(),document.getElementById("finalCpuScore").textContent=this.state.cpuScore.toString();const e=document.getElementById("newGamePoints");this.state.winTarget===0||t?(e.textContent=`New Points: +${this.state.newPoints}`,e.classList.remove("points-gain","halo-blink"),e.classList.add("points-gain"),setTimeout(()=>e.classList.add("halo-blink"),2e3)):(e.textContent="",e.classList.remove("points-gain","halo-blink"));const a=t?"end-win":"end-lose";this.state.sounds[a].currentTime=0,this.state.sounds[a].play(),this.playBgm("end")}resetGame(){this.ui.toggleScreens("startScreen"),this.state.gameStarted=!1,this.state.isRoundActive=!1,this.state.playerScore=0,this.state.cpuScore=0,this.state.failCount=0,this.state.playerLives=0,this.state.newPoints=0,this.state.objDTriggerCount=0,this.state.objDActive=!1,this.state.lastCheckedWins=0,this.state.playerChoiceHistory=[],this.state.winTarget=void 0,this.state.difficulty="normal",document.getElementById("startScreen").querySelector("h2").textContent="CHOOSE A GAME MODE",document.getElementById("goal-mode").classList.remove("hidden"),document.getElementById("winInfinity").classList.remove("hidden"),document.getElementById("goal-options").classList.remove("visible"),document.getElementById("goal-options").classList.add("hidden"),document.querySelector(".difficulty-toggle").classList.add("hidden"),document.getElementById("difficulty-normal").classList.remove("selected"),document.getElementById("difficulty-hard").classList.remove("selected"),document.getElementById("start").classList.add("hidden"),document.querySelectorAll(".goal-option").forEach(t=>t.classList.remove("selected")),this.ui.updateScore(),this.ui.updateHighScoreDisplay(),this.ui.updateGamePoints(),this.ui.initializeLives(),this.playBgm("opening")}toggleBgm(){this.state.bgmMuted=!this.state.bgmMuted;const t=[document.getElementById("startSoundControl"),document.getElementById("gameSoundControl"),document.getElementById("endSoundControl")];this.state.bgmMuted?(this.stopBgm(),t.forEach(e=>e.classList.add("muted")),console.log("BGM muted")):(t.forEach(e=>e.classList.remove("muted")),document.getElementById("startScreen").classList.contains("hidden")?document.getElementById("gameScreen").classList.contains("hidden")?document.getElementById("endScreen").classList.contains("hidden")||this.playBgm("end"):this.playBgm("battle"):this.playBgm("opening"),console.log("BGM unmuted"))}async playEnhancedSound(t){const e=this.state.sounds[t],i=await(await fetch(e.src)).arrayBuffer(),s=await this.state.audioContext.decodeAudioData(i),l=this.state.audioContext.createBufferSource();l.buffer=s;const d=this.state.audioContext.createGain();d.gain.value=.8;const r=this.state.audioContext.createConvolver(),c=await this.createImpulseResponse();r.buffer=c;const u=this.state.audioContext.createBiquadFilter();u.type="lowshelf",u.frequency.value=200,u.gain.value=10,l.connect(d),d.connect(u),u.connect(r),r.connect(this.state.audioContext.destination),l.start()}async createImpulseResponse(){const t=this.state.audioContext.sampleRate*1,e=this.state.audioContext.createBuffer(2,t,this.state.audioContext.sampleRate),a=e.getChannelData(0),i=e.getChannelData(1);for(let s=0;s<t;s++){const l=Math.exp(-s/(this.state.audioContext.sampleRate*.5));a[s]=(Math.random()*2-1)*l,i[s]=(Math.random()*2-1)*l}return e}checkGameEnd(){this.state.winTarget===0?this.state.playerLives<=0&&(this.endGame(!1),this.logic.checkHighScore()):this.state.playerScore>=this.state.winTarget?this.endGame(!0):this.state.cpuScore>=this.state.winTarget&&this.endGame(!1)}}const k=new T(S,P,b);window.addEventListener("DOMContentLoaded",()=>{console.log("DOM fully loaded, initializing game"),b.initializeLives(),k.setupEvents()});
